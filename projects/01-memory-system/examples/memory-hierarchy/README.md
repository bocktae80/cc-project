# 예제 2: 메모리 계층 구조 ⭐⭐

> 여러 개의 메모리 파일이 있으면, 클로드는 어떤 걸 우선할까?

## 이 예제에서 배우는 것

- 메모리에 "레벨"이 있다는 것
- 같은 규칙이 충돌하면 어떻게 되는지
- `.claude/rules/`로 규칙을 파일별로 나누는 방법

---

## 메모리 계층 이해하기

클로드 코드의 메모리에는 3단계 레벨이 있습니다:

```
레벨 3 (가장 높은 우선순위)
┌─────────────────────────────┐
│ 프로젝트 메모리              │
│ ./CLAUDE.md                 │
│ ./CLAUDE.local.md           │
│ ./.claude/rules/*.md        │
│ "이 프로젝트에서는 이렇게!" │
└─────────────────────────────┘
          ▲ 이기는 쪽

레벨 2
┌─────────────────────────────┐
│ 워크스페이스 메모리           │
│ ../CLAUDE.md (상위 폴더)     │
│ "이 작업 공간에서는 이렇게!" │
└─────────────────────────────┘

레벨 1 (가장 낮은 우선순위)
┌─────────────────────────────┐
│ 유저 메모리                  │
│ ~/.claude/CLAUDE.md          │
│ "나는 항상 이렇게!"          │
└─────────────────────────────┘
```

### 핵심 규칙: 가까운 것이 이긴다!

학교에 비유하면:
- **유저 메모리** = 교육부 규칙 (전국 공통)
- **워크스페이스 메모리** = 학교 규칙 (우리 학교만)
- **프로젝트 메모리** = 반 규칙 (우리 반만)

"급식 시간에 핸드폰 사용 금지"가 교육부 규칙이지만,
우리 반 규칙에 "급식 시간 핸드폰 허용"이 있으면?
→ **반 규칙(프로젝트 메모리)이 이깁니다!**

---

## 데모 프로젝트 살펴보기

`demo-project/` 폴더를 살펴보세요:

```
demo-project/
├── CLAUDE.md           ← 프로젝트 메모리 (레벨 3)
├── CLAUDE.local.md     ← 로컬 메모리 (나만)
├── .claude/
│   └── rules/
│       ├── style.md    ← 코드 스타일 규칙
│       └── testing.md  ← 테스트 규칙
└── src/
    └── example.js
```

### 각 파일의 역할

#### CLAUDE.md (팀 공유)
```markdown
프로젝트 전체 규칙
- 들여쓰기: 2칸
- 언어: TypeScript 우선
```

#### CLAUDE.local.md (나만)
```markdown
개인 설정
- 디버그 모드: ON
- 로컬 API URL: http://localhost:3000
```
→ 이 파일은 `.gitignore`에 추가해서 git에 올리지 않습니다!

#### .claude/rules/style.md (모듈식 규칙)
```markdown
코드 스타일만 따로 관리
- 세미콜론: 사용
- 따옴표: 작은따옴표
```

#### .claude/rules/testing.md (모듈식 규칙)
```markdown
테스트 규칙만 따로 관리
- 테스트 프레임워크: Vitest
- 테스트 파일 위치: __tests__ 폴더
```

---

## 따라하기: 충돌 실험

### 실험 1: 들여쓰기 충돌

만약 유저 메모리(`~/.claude/CLAUDE.md`)에 이렇게 적고:
```markdown
들여쓰기: 4칸
```

프로젝트 메모리(`./CLAUDE.md`)에 이렇게 적으면:
```markdown
들여쓰기: 2칸
```

**결과:** 클로드는 **2칸 들여쓰기**를 사용합니다 (프로젝트가 우선!)

### 실험 2: 규칙 합산

유저 메모리:
```markdown
변수명: camelCase
```

프로젝트 메모리:
```markdown
주석: 한국어
```

**결과:** 클로드는 **둘 다 적용**합니다! (충돌이 아니면 합쳐짐)

---

## 실습: 3단계 메모리 설정하기

### Step 1: 유저 메모리 설정

```bash
# 유저 메모리 파일 열기 (없으면 새로 생성)
claude /memory
```

이런 내용을 추가해보세요:
```markdown
# 내 공통 규칙
- 설명은 한국어로
- 에러 메시지도 한국어로
```

### Step 2: 프로젝트 메모리 설정

`demo-project/` 폴더에서:
```bash
cd demo-project/
# CLAUDE.md 수정
```

### Step 3: 규칙 분리해보기

`.claude/rules/` 폴더에 규칙 파일을 추가해보세요:
```bash
# 새 규칙 파일 만들기
# demo-project/.claude/rules/ 폴더에 my-rule.md 파일 생성
```

```markdown
# 내 규칙
- 새 기능을 추가할 때 항상 테스트도 함께 작성
```

---

## `.claude/rules/` 활용 팁

규칙이 많아지면 하나의 CLAUDE.md가 길어집니다. 이럴 때 `.claude/rules/`로 분리하면 좋습니다:

```
.claude/rules/
├── style.md       ← 코드 스타일
├── testing.md     ← 테스트 규칙
├── naming.md      ← 이름 짓기 규칙
└── workflow.md    ← 작업 방식 규칙
```

**장점:**
- 규칙을 주제별로 찾기 쉬움
- 필요한 규칙만 수정 가능
- 팀원들이 나눠서 관리 가능

---

## 핵심 정리

```
메모리 우선순위 (높은 순):

1. 프로젝트 CLAUDE.md     ← "이 프로젝트에서는!"
2. 상위 폴더 CLAUDE.md    ← "이 작업 공간에서는!"
3. 유저 ~/.claude/CLAUDE.md ← "나는 항상!"

충돌하면? → 가까운 것(프로젝트)이 이김!
충돌 없으면? → 모두 합쳐서 적용!
```
